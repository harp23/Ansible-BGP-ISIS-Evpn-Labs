----- .vscode/settings.json -----
{
  "python.defaultInterpreterPath": "${workspaceFolder}/venv/bin/python",
  "ansible.python.interpreterPath": "${workspaceFolder}/venv/bin/python",
  "ansible.ansible.path": "${workspaceFolder}/venv/bin/ansible",
  "ansible.executionEnvironment.enabled": false,
  "ansible.validation.lint.enabled": true,
  "ansible.validation.lint.path": "${workspaceFolder}/venv/bin/ansible-lint"
}


----- README.md -----
# CML EVPN Lab (Flexible, Variable-Driven)

This starter set provisions a 5-router CML lab:

```
PE1  --  P1  --  P2  --  PE2
     \--  PE4   (PE1 & PE4 all-active multihoming toward CE1)
```

- **Underlay**: ISIS + MPLS LDP on all core-facing links (PEs & Ps)
- **Overlay**: BGP EVPN on PEs (full-mesh iBGP between PE loopbacks)
- **AA Multihoming**: PE1 & PE4 share an ESI and bundle interface
- **Telemetry**: Model-driven telemetry dial-out to your collector (Grafana/Telegraf)

## 1) Prereqs

Create and activate a Python venv, install Ansible, and required collections:

```bash
python3 -m venv venv
source venv/bin/activate
pip install ansible ansible-lint
ansible-galaxy collection install -r collections/requirements.yml -p ./collections
```

## 2) Update device access & interfaces

Edit `group_vars/all.yml` and `host_vars/*`:
- Set `ansible_user` (or in `ansible.cfg` as `remote_user`)
- Adjust `core_ifaces` names per node
- Confirm `loopback_ip` per device
- Set telemetry destination if used

## 3) Run underlay
```bash
ansible-playbook playbooks/underlay.yml
```

## 4) Run overlay (EVPN)
```bash
ansible-playbook playbooks/bgp_evpn.yml
```

## 5) Telemetry (optional)
```bash
ansible-playbook playbooks/telemetry.yml
```

> Tip: The configuration is intentionally minimal and variable-driven. Extend templates to add policies, route-maps, and per-platform specifics as needed.


----- ansible.cfg -----
[defaults]
# Project-scoped inventory
inventory = ./inventory.yml

# Output & behavior
stdout_callback = yaml
bin_ansible_callbacks = True
retry_files_enabled = False
host_key_checking = False
forks = 20
timeout = 30
interpreter_python = auto_silent

# Where roles & collections are looked up (project first)
roles_path = ./roles:~/.ansible/roles
collections_paths = ./collections:~/.ansible/collections

[ssh_connection]
pipelining = True
ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes

[inventory]
# Enable common inventory plugins
enable_plugins = host_list, script, yaml, ini, toml, auto


----- cml-evpn-lab -----
python3 -m venv venv
source venv/bin/activate

----- collections/requirements.yml -----
---
collections:
  - name: cisco.iosxr


----- group_vars/all.yml -----
---
# Global defaults to keep the lab flexible
bgp_as: 65000

# EVPN defaults
evpn_evi: 100
rt_import: "100:100"
rt_export: "100:100"
bridge_group: EVPN

# Underlay / IGP defaults
isis_process: CORE
isis_level: level-2-only
# Build a valid NET ID from loopback; you may override per-host if desired
isis_net_prefix: "49.0001"
isis_net_tail: "00"

# Telemetry / gRPC dial-out (point this to your collector/Telegraf)
telemetry_dst_ip: 192.168.100.50
telemetry_dst_port: 57000
telemetry_protocol: grpc

# XR connection defaults (override in inventory if different)
ansible_network_os: iosxr
ansible_connection: network_cli
# Set your device login username here or in ansible.cfg (remote_user)
# ansible_user: YOUR_USERNAME
# ansible_password: YOUR_PASSWORD  # (discouraged; prefer SSH keys)


----- host_vars/P1.yml -----
---
loopback_ip: 1.1.1.11
role: P
core_ifaces:
  - GigabitEthernet0/0/0/0
  - GigabitEthernet0/0/0/1


----- host_vars/P2.yml -----
---
loopback_ip: 1.1.1.12
role: P
core_ifaces:
  - GigabitEthernet0/0/0/0
  - GigabitEthernet0/0/0/1


----- host_vars/PE1.yml -----
---
loopback_ip: 1.1.1.1
role: PE
# Core-facing interfaces used for ISIS + LDP
core_ifaces:
  - GigabitEthernet0/0/0/0
  - GigabitEthernet0/0/0/1
# CE-facing bundle for all-active multihoming
aa_bundle_interface: Bundle-Ether1
esi: 0000.0000.0001.0001.0001


----- host_vars/PE2.yml -----
---
loopback_ip: 1.1.1.2
role: PE
core_ifaces:
  - GigabitEthernet0/0/0/0
  - GigabitEthernet0/0/0/1
# Single-homed CE attachment example
ce_interface: GigabitEthernet0/0/0/2


----- host_vars/PE4.yml -----
---
loopback_ip: 1.1.1.4
role: PE
core_ifaces:
  - GigabitEthernet0/0/0/0
  - GigabitEthernet0/0/0/1
aa_bundle_interface: Bundle-Ether1
esi: 0000.0000.0001.0001.0001


----- inventory.yml -----
---
all:
  children:
    pe:
      hosts:
        PE1:
          ansible_host: 10.0.0.1
        PE2:
          ansible_host: 10.0.0.2
        PE4:
          ansible_host: 10.0.0.4
    core:
      hosts:
        P1:
          ansible_host: 10.0.0.11
        P2:
          ansible_host: 10.0.0.12
    pe_aa:   # PEs participating in all-active multihoming toward CE1
      hosts:
        PE1:
        PE4:


----- playbooks/bgp_evpn.yml -----
---
- name: Configure BGP EVPN on PEs
  hosts: pe
  gather_facts: no
  tasks:
    - name: Configure BGP EVPN AF and neighbors
      cisco.iosxr.iosxr_config:
        src: templates/bgp_evpn.j2

- name: Configure EVPN all-active multihoming on PE1/PE4
  hosts: pe_aa
  gather_facts: no
  tasks:
    - name: Configure EVPN Ethernet-Segment AA bundle
      cisco.iosxr.iosxr_config:
        src: templates/evpn_aa.j2


----- playbooks/telemetry.yml -----
---
- name: Configure model-driven telemetry to Grafana/collector
  hosts: pe
  gather_facts: no
  tasks:
    - name: Push telemetry destination and subscription
      cisco.iosxr.iosxr_config:
        src: templates/telemetry.j2


----- playbooks/underlay.yml -----
---
- name: Configure ISIS underlay and MPLS LDP on all nodes
  hosts: pe,core
  gather_facts: no
  tasks:
    - name: Build ISIS NET string from loopback
      set_fact:
        isis_net: "{{ isis_net_prefix }}.{{ (loopback_ip | regex_replace('\.', '')) }}.{{ isis_net_tail }}"

    - name: Configure ISIS
      cisco.iosxr.iosxr_config:
        src: templates/isis.j2

    - name: Configure LDP on core-facing interfaces
      when: core_ifaces is defined and core_ifaces | length > 0
      cisco.iosxr.iosxr_config:
        src: templates/ldp.j2


----- templates/bgp_evpn.j2 -----
router bgp {{ bgp_as }}
 bgp router-id {{ loopback_ip }}
 !
 address-family l2vpn evpn
  retain route-target all
 !
{% for peer in groups['pe'] if peer != inventory_hostname %}
 neighbor {{ hostvars[peer].loopback_ip }}
  remote-as {{ bgp_as }}
  update-source Loopback0
  address-family l2vpn evpn
   send-community both
{% endfor %}
!
# Minimal EVPN EVI context (extend as needed)
l2vpn evpn
 evi {{ evpn_evi }}
  route-target import {{ rt_import }}
  route-target export {{ rt_export }}


----- templates/evpn_aa.j2 -----
evpn
 evi {{ evpn_evi }}
  route-target import {{ rt_import }}
  route-target export {{ rt_export }}
!
interface {{ aa_bundle_interface }}
 evpn ethernet-segment
  identifier {{ esi }}
  redundancy all-active
!
l2vpn
 bridge group {{ bridge_group }}
  bridge-domain BD{{ evpn_evi }}
   interface {{ aa_bundle_interface }}
    evi {{ evpn_evi }}


----- templates/isis.j2 -----
router isis {{ isis_process }}
 net {{ isis_net }}
 {{ isis_level }}
!
interface Loopback0
 isis {{ isis_process }}
 passive
!
{% for ifname in core_ifaces | default([]) %}
interface {{ ifname }}
 isis {{ isis_process }}
!
{% endfor %}


----- templates/ldp.j2 -----
mpls ldp
 router-id Loopback0
!
{% for ifname in core_ifaces | default([]) %}
interface {{ ifname }}
 mpls ldp
!
{% endfor %}


----- templates/telemetry.j2 -----
telemetry model-driven
 destination-group GRAFANA
  address-family ipv4 {{ telemetry_dst_ip }} port {{ telemetry_dst_port }} protocol {{ telemetry_protocol }}
 sensor-group IOSXR_BASE
  sensor-path Cisco-IOS-XR-infra-statsd-oper:infra-statistics/interfaces/interface/latest/generic-counters
 subscription BASE_SUB
  sensor-group-id IOSXR_BASE sample-interval 30000
  destination-id GRAFANA


